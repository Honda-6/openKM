<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
             xmlns:security="http://www.springframework.org/schema/security"
             xmlns:context="http://www.springframework.org/schema/context"
             xmlns:jee="http://www.springframework.org/schema/jee"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://www.springframework.org/schema/beans
                                 http://www.springframework.org/schema/beans/spring-beans.xsd
                                 http://www.springframework.org/schema/security
                                 http://www.springframework.org/schema/security/spring-security.xsd
                                 http://www.springframework.org/schema/context
                                 http://www.springframework.org/schema/context/spring-context.xsd
                                 http://www.springframework.org/schema/jee
                                 http://www.springframework.org/schema/jee/spring-jee.xsd">

  <context:component-scan base-package="com.openkm"/>

  <!-- OpenKM API -->
  <beans:import resource="soap.xml"/>
  <beans:import resource="rest.xml"/>
  <beans:import resource="cmis.xml"/>

  <!-- Swagger -->
  <beans:bean id="swagger2Feature" class="com.openkm.core.Swagger2Config" />

  <!--
  <beans:bean class="org.springframework.beans.factory.config.MethodInvokingFactoryBean">
      <beans:property name="targetClass" value="org.springframework.security.core.context.SecurityContextHolder" />
      <beans:property name="targetMethod" value="setStrategyName" />
      <beans:property name="arguments" value="_INHERITABLETHREADLOCAL" />
  </beans:bean>
  -->

  <security:global-method-security secured-annotations="enabled"/>

  <!-- Needed for changing default role prefix -->
<!--  <beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.AffirmativeBased">-->
<!--    <beans:constructor-arg>-->
<!--      <beans:list>-->
<!--        <beans:bean class="org.springframework.security.web.access.expression.WebExpressionVoter"/>-->
<!--        <beans:ref bean="roleVoter"/>-->
<!--        <beans:bean class="org.springframework.security.access.vote.AuthenticatedVoter"/>-->
<!--      </beans:list>-->
<!--    </beans:constructor-arg>-->
<!--  </beans:bean>-->
  <context:property-placeholder location="classpath:application.properties" />
  <!-- Security access logger -->
  <beans:bean id="loggerListener" class="com.openkm.spring.LoggerListener"/>
  <!-- <beans:bean id="keycloakUtils" class="com.openkm.util.KeycloakUtils"/> -->
  <beans:bean id="keycloakAuthProvider" class="com.openkm.spring.KeycloakAuthenticationProvider"/>
  <jee:jndi-lookup id="dataSource" jndi-name="jdbc/OpenKMDS" resource-ref="true"/>
  <!-- Security configuration moved to $CATALINA_HOME/OpenKM.xml -->
  <!-- WINFIX
  <security:authentication-manager alias="authenticationManager">
      <security:authentication-provider>
          <security:password-encoder hash="md5"/>
          <security:jdbc-user-service
              data-source-ref="dataSource"
              users-by-username-query="select usr_id, usr_password, 1 from OKM_USER where usr_id=? and usr_active='T'"
              authorities-by-username-query="select ur_user, ur_role from OKM_USER_ROLE where ur_user=?"/>
      </security:authentication-provider>
  </security:authentication-manager>
  WINFIX -->
</beans:beans>
